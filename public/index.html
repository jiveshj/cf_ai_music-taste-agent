<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Taste Discovery üéµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            font-size: 28px;
            font-weight: 700;
        }

        .emoji {
            font-size: 32px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(to bottom, #f7f9fc, #ffffff);
            border-radius: 16px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 85%;
            animation: slideIn 0.4s ease;
            line-height: 1.5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 2px solid #f0f0f0;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            color: #666;
        }

        .quick-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e3e8ef;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .profile-section {
            overflow-y: auto;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .genre-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .genre-tag {
            padding: 6px 14px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
        }

        .session-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            position: relative;
        }

        .session-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .session-card:hover .delete-btn {
            opacity: 1;
        }

        .song-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .artist-name {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .session-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #999;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.genre {
            background: #dbeafe;
            color: #2563eb;
        }

        .badge.mood {
            background: #fef3c7;
            color: #d97706;
        }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 1;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .insights {
            background: linear-gradient(135deg, #10b98115 0%, #05966915 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .insight-item {
            padding: 8px 0;
            color: #059669;
            font-weight: 500;
        }

        .log-form {
            background: #f7f9fc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e3e8ef;
            border-radius: 8px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .panel {
                min-height: 500px;
            }

            .delete-btn {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <div class="header">
                <span class="emoji">üéµ</span>
                <h1>Music Taste Discovery</h1>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message assistant">
                    Hey! I'm here to help you discover your music taste! Tell me about songs you love, artists you can't stop listening to, or just chat about music. I'll help you understand your unique music preferences! üéß
                </div>
            </div>

            <div class="input-section">
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickMessage('What are my favorite genres?')">My Genres</button>
                    <button class="quick-btn" onclick="quickMessage('Give me insights about my taste')">Insights</button>
                    <button class="quick-btn" onclick="quickMessage('Can you share some music recommendations?')">Share Music</button>
                    <button class="quick-btn" onclick="toggleLogForm()">üìù Log a Song</button>
                </div>
                
                <div class="log-form" id="logForm" style="display: none;">
                    <div class="form-group">
                        <label>Song Name</label>
                        <input type="text" id="songName" placeholder="Enter song name">
                    </div>
                    <div class="form-group">
                        <label>Artist</label>
                        <input type="text" id="artistName" placeholder="Enter artist name">
                    </div>
                    <div class="form-group">
                        <label>Genre</label>
                        <select id="genreSelect">
                            <option value="pop">Pop</option>
                            <option value="rock">Rock</option>
                            <option value="hip hop">Hip Hop</option>
                            <option value="indie">Indie</option>
                            <option value="electronic">Electronic</option>
                            <option value="jazz">Jazz</option>
                            <option value="r&b">R&B</option>
                            <option value="country">Country</option>
                            <option value="metal">Metal</option>
                            <option value="folk">Folk</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mood</label>
                        <select id="moodSelect">
                            <option value="happy">Happy</option>
                            <option value="energetic">Energetic</option>
                            <option value="chill">Chill</option>
                            <option value="sad">Sad</option>
                            <option value="romantic">Romantic</option>
                            <option value="upbeat">Upbeat</option>
                            <option value="melancholic">Melancholic</option>
                            <option value="peaceful">Peaceful</option>
                        </select>
                    </div>
                    <button onclick="logSong()" style="width: 100%;">Add to My Music</button>
                </div>

                <div class="input-container">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Tell me about music you love..." 
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                    />
                    <button onclick="sendMessage()" id="sendBtn">Send</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="header">
                <span class="emoji">üìä</span>
                <h1>Your Profile</h1>
            </div>
            
            <div class="profile-section" id="profileSection">
                <div class="loading">Loading your music profile...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function toggleLogForm() {
            const form = document.getElementById('logForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function logSong() {
            const song = document.getElementById('songName').value;
            const artist = document.getElementById('artistName').value;
            const genre = document.getElementById('genreSelect').value;
            const mood = document.getElementById('moodSelect').value;

            if (!song || !artist) {
                alert('Please enter song and artist name');
                return;
            }

            try {
                await fetch(`${API_BASE}/api/log-song`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ song, artist, genre, mood })
                });

                document.getElementById('songName').value = '';
                document.getElementById('artistName').value = '';
                toggleLogForm();

                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML += `
                    <div class="message assistant">
                        Added "${song}" by ${artist} to your music profile! üéµ
                    </div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;

                await loadProfile();
            } catch (error) {
                console.error('Error logging song:', error);
            }
        }

        async function deleteSong(sessionId, songName) {
            if (!confirm(`Delete "${songName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/delete-song`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });

                const result = await response.json();
                
                if (result.success) {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML += `
                        <div class="message assistant">
                            Deleted "${songName}" from your profile! üóëÔ∏è
                        </div>
                    `;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    await loadProfile();
                } else {
                    alert('Failed to delete song');
                }
            } catch (error) {
                console.error('Error deleting song:', error);
                alert('Error deleting song');
            }
        }

        function quickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            const chatContainer = document.getElementById('chatContainer');
            const sendBtn = document.getElementById('sendBtn');
            
            chatContainer.innerHTML += `
                <div class="message user">${escapeHtml(message)}</div>
            `;
            
            input.value = '';
            sendBtn.disabled = true;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                chatContainer.innerHTML += `
                    <div class="message assistant">${escapeHtml(data.response)}</div>
                `;
                
                await loadProfile();
            } catch (error) {
                chatContainer.innerHTML += `
                    <div class="message assistant">Oops! Something went wrong. Try again?</div>
                `;
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function loadProfile() {
            const profileSection = document.getElementById('profileSection');
            
            try {
                const response = await fetch(`${API_BASE}/api/profile`);
                const profile = await response.json();
                
                let html = `
                    <div class="stat-card">
                        <div class="stat-title">Songs Logged</div>
                        <div class="stat-value">${profile.totalSongs}</div>
                    </div>
                `;

                if (profile.favoriteGenres.length > 0) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-title">Your Genres</div>
                            <div class="genre-tags">
                                ${profile.favoriteGenres.map(g => 
                                    `<span class="genre-tag">${escapeHtml(g)}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                if (profile.topMoods.length > 0) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-title">Your Moods</div>
                            <div class="genre-tags">
                                ${profile.topMoods.map(m => 
                                    `<span class="genre-tag">${escapeHtml(m)}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                if (profile.insights.length > 0) {
                    html += `
                        <div class="insights">
                            <div class="stat-title">Insights</div>
                            ${profile.insights.map(i => 
                                `<div class="insight-item">‚ú® ${escapeHtml(i)}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                if (profile.recentSessions.length > 0) {
                    html += `<div class="stat-title" style="margin-bottom: 12px;">Recent Listens</div>`;
                    profile.recentSessions.slice(0, 5).forEach(session => {
                        html += `
                            <div class="session-card">
                                <button 
                                    class="delete-btn" 
                                    onclick="deleteSong('${session.id}', '${escapeHtml(session.song)}')"
                                    title="Delete this song"
                                >
                                    ‚úï Delete
                                </button>
                                <div class="song-title">${escapeHtml(session.song)}</div>
                                <div class="artist-name">${escapeHtml(session.artist)}</div>
                                <div class="session-meta">
                                    <span class="badge genre">${escapeHtml(session.genre)}</span>
                                    <span class="badge mood">${escapeHtml(session.mood)}</span>
                                </div>
                            </div>
                        `;
                    });
                }

                profileSection.innerHTML = html;
            } catch (error) {
                profileSection.innerHTML = '<div class="loading">Error loading profile</div>';
                console.error('Error loading profile:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadProfile();
        setInterval(loadProfile, 10000);
    </script>
</body>
</html>
